<!-- Highcharts scripts -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script>
<script src="https://code.highcharts.com/modules/solid-gauge.js"></script>

<!-- Optional styles (only apply if allowed in your SolarWinds widget container) -->
<style>
  .highcharts-figure {
    max-width: 500px;
    margin: 1em auto;
  }
  .highcharts-description {
    margin: 0.5rem 10px;
    text-align: center;
    color: #666;
    font-size: 14px;
  }
</style>

<figure class="highcharts-figure">
  <div id="voltageGauge"></div>
  <p class="highcharts-description">Live battery voltage gauge with custom threshold zones.</p>
</figure>

<script>
  const swql = `
    SELECT TOP 1 RawStatus
    FROM Orion.NPM.CustomPollerStatistics
    WHERE CustomPollerAssignmentID = 'd3b9e8cb-e880-4505-8e73-8563e53c0561'
    ORDER BY DateTime DESC
  `;

  const params = JSON.stringify({ query: swql, parameters: {} });

  $.ajax({
    type: 'POST',
    url: '/Orion/Services/Information.asmx/QueryWithParameters',
    data: params,
    contentType: 'application/json; charset=utf-8',
    dataType: 'json',
    success: function (response) {
      const rows = response.d.Rows;
      const voltage = (rows.length && !isNaN(parseFloat(rows[0][0]))) ? parseFloat(rows[0][0]) : null;

      if (voltage === null) {
        document.getElementById("voltageGauge").innerHTML = "<p>No voltage data found</p>";
        return;
      }

      // Modern semi-circular gauge
      Highcharts.chart('voltageGauge', {
        chart: {
          type: 'gauge',
          height: '80%',
          backgroundColor: 'transparent'
        },
        title: {
          text: 'Battery Voltage'
        },
        pane: {
          startAngle: -90,
          endAngle: 89.9,
          background: null,
          center: ['50%', '75%'],
          size: '110%'
        },
        yAxis: {
          min: 190, // Minimum for the gauge cluster
          max: 270, // Maximum for the gauge cluster
          tickPixelInterval: 72,
          tickPosition: 'inside',
          tickLength: 20,
          tickWidth: 2,
          tickColor: '#fff',
          labels: {
            distance: 20,
            style: { fontSize: '14px' }
          },
          lineWidth: 0,
          title: {
            text: 'Volts'
          },
          plotBands: [
            { from: 190, to: 210, color: '#DF5353', thickness: 20 }, // Critical Low
            { from: 210, to: 219, color: '#DDDF0D', thickness: 20 }, // Warning Low
            { from: 220, to: 250, color: '#55BF3B', thickness: 20 }, // Normal
            { from: 251, to: 260, color: '#DDDF0D', thickness: 20 }, // Warning High
            { from: 260, to: 270, color: '#DF5353', thickness: 20 } // Critical High
          ]
        },
        series: [{
          name: 'Voltage',
          data: [voltage],
          tooltip: {
            valueSuffix: ' V'
          },
          dataLabels: {
            format: '{y} V',
            borderWidth: 0,
            color: '#333333',
            style: {
              fontSize: '16px'
            }
          },
          dial: {
            radius: '80%',
            backgroundColor: 'gray',
            baseWidth: 12,
            baseLength: '0%',
            rearLength: '0%'
          },
          pivot: {
            backgroundColor: 'gray',
            radius: 6
          }
        }]
      });
    },
    error: function (err) {
      console.error("SWIS query failed:", err);
      document.getElementById("voltageGauge").innerHTML = "<p>Error loading data</p>";
    }
  });
</script>
